

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á - ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/all.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8f9fa; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .admin-section, .employee-section { display: none; }
        .login-card { max-width: 400px; margin: 40px auto; }
        .btn-line { background-color: #06c755; color: white; border: none; }
        .btn-line:hover { background-color: #05a647; color: white; }
        .delete-btn { color: #dc3545; cursor: pointer; border: 1px solid #dc3545; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; text-decoration: none; }
        .badge-advance { background-color: #ff4757; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="text-center mb-4">
        <h2 class="fw-bold text-dark">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á</h2>
        <p class="badge bg-white text-muted shadow-sm px-3 py-2" id="currentDateDisplay"></p>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ -->
    <div id="mainLogin" class="login-card">
        <div class="card p-4 text-center shadow">
            <h5 class="mb-4 fw-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h5>
            <button class="btn btn-primary w-100 mb-3 py-3 fw-bold shadow-sm" onclick="showEmployeeLogin()">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å)</button>
            <button class="btn btn-outline-secondary w-100 py-3 fw-bold" onclick="askAdminPassword()">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô (Admin)</button>
        </div>
    </div>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
    <div id="employeeSelect" class="login-card" style="display:none;">
        <div class="card p-4 shadow">
            <h4 class="text-center mb-3 fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h4>
            <div id="employeeNameButtons" class="d-grid gap-2"></div>
            <button class="btn btn-link mt-3 text-secondary" onclick="location.reload()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>
    </div>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™‡πà PIN ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
    <div id="employeePinInput" class="login-card" style="display:none;">
        <div class="card p-4 text-center shadow">
            <h4 id="selectedEmpName" class="mb-3 text-primary fw-bold"></h4>
            <p class="small text-muted">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ PIN ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <input type="password" id="empPin" class="form-control form-control-lg text-center mb-3" placeholder="****" inputmode="numeric">
            <button class="btn btn-primary w-100 py-2 fw-bold" onclick="verifyEmpPin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button class="btn btn-link mt-2 text-secondary" onclick="showEmployeeLogin()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>
    </div>

    <!-- ================= ‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ================= -->
    <div id="employeePortal" class="employee-section">
        <div class="card p-4 mb-3 bg-primary text-white text-center shadow-lg">
            <h6 class="opacity-75">‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h6>
            <h1 class="fw-bold" id="empBalanceDisplay">0.00</h1>
            <div id="empAdvanceInfo" class="badge bg-danger mt-2 px-3 py-2" style="font-size: 0.9rem;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏õ: 0</div>
            <div class="mt-2 small opacity-75">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: <span id="empNetDisplay">0</span></div>
        </div>
        <div class="card p-3 shadow-sm">
            <h6 class="fw-bold mb-3 border-bottom pb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
            <div class="table-responsive">
                <table class="table table-sm small text-center">
                    <thead class="table-light"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏ù‡∏≤‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°</th></tr></thead>
                    <tbody id="empHistoryTable"></tbody>
                </table>
            </div>
            <button class="btn btn-outline-secondary w-100 mt-3" onclick="location.reload()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <!-- ================= ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô (Admin) ================= -->
    <div id="adminPanel" class="admin-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold text-primary m-0">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡πâ‡∏≤‡∏ô</h4>
            <button class="btn btn-dark btn-sm" onclick="location.reload()">Logout</button>
        </div>

        <ul class="nav nav-pills nav-fill mb-3 bg-white rounded p-1 shadow-sm" id="adminTab">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-daily">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-mom">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡πà‡∏á‡πÅ‡∏°‡πà</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-manage">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô</button></li>
        </ul>

        <div class="tab-content">
            <!-- 1. ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ -->
            <div class="tab-pane fade show active" id="tab-daily">
                <div id="dailyEntryList" class="d-grid gap-2"></div>
            </div>

            <!-- 2. ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡πà‡∏á‡πÅ‡∏°‡πà -->
            <div class="tab-pane fade" id="tab-mom">
                <div class="card p-3 mb-3 border-success border-2 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-success fw-bold m-0">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</h6>
                        <button class="btn btn-line btn-sm fw-bold shadow-sm" onclick="copyDailyReport()">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡πà‡∏á LINE</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm small text-center align-middle">
                            <thead class="table-light"><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÇ‡∏≠‡∏ô</th><th>‡∏™‡∏î</th><th>‡∏ù‡∏≤‡∏Å</th><th>‡∏•‡∏ö</th></tr></thead>
                            <tbody id="todayReportBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card p-3 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-primary fw-bold m-0">‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h6>
                        <button class="btn btn-outline-primary btn-sm fw-bold" onclick="copyMonthlyReport()">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                    </div>
                    <div id="monthlySummaryBody"></div>
                </div>
            </div>

            <!-- 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
            <div class="tab-pane fade" id="tab-manage">
                <div class="card p-3 mb-3 shadow-sm">
                    <h6 class="fw-bold">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h6>
                    <div class="row g-2">
                        <div class="col-12"><input type="text" id="newName" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"></div>
                        <div class="col-6"><input type="number" id="newWage" class="form-control" placeholder="‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á"></div>
                        <div class="col-6"><input type="text" id="newPin" class="form-control" placeholder="PIN 4 ‡∏´‡∏•‡∏±‡∏Å"></div>
                        <button class="btn btn-primary fw-bold mt-2" onclick="addEmployee()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </div>
                <div id="adminEmpList"></div>

                <!-- ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) -->
                <div class="card p-3 mt-4 border-dashed shadow-sm bg-light">
                    <h6 class="fw-bold text-muted mb-3"><i class="fas fa-database me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <button class="btn btn-outline-secondary btn-sm w-100 fw-bold" onclick="exportBackup()">
                                <i class="fas fa-download me-1"></i> ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-danger btn-sm w-100 fw-bold" onclick="document.getElementById('importFile').click()">
                                <i class="fas fa-upload me-1"></i> ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                            <input type="file" id="importFile" hidden accept=".json" onchange="importBackup(event)">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á -->
<div class="modal fade" id="recordModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header border-0 pb-0"><h5 class="fw-bold" id="modalEmpName"></h5></div>
            <div class="modal-body">
                <div class="mb-3"><label class="small fw-bold">‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</label><input type="number" id="mWage" class="form-control form-control-lg bg-light"></div>
                <div class="row">
                    <div class="col-6"><label class="small fw-bold text-primary">‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô</label><input type="number" id="mPaidTransfer" class="form-control form-control-lg border-primary" value="0"></div>
                    <div class="col-6"><label class="small fw-bold text-warning">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</label><input type="number" id="mPaidCash" class="form-control form-control-lg border-warning" value="0"></div>
                </div>
                <div id="depositAlert" class="alert alert-info mt-3 mb-0 py-2 small fw-bold text-center">‡∏ù‡∏≤‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°: <span id="mDeposit">0</span> ‡∏ö‡∏≤‡∏ó</div>
            </div>
            <div class="modal-footer border-0">
                <button class="btn btn-danger me-auto fw-bold" onclick="recordAdvance()">‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                <button class="btn btn-primary px-4 fw-bold" onclick="saveDaily()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAmAmceLCl40QTnWe3Prso-psMN6jNnY-U",
        authDomain: "supertest02-689bd.firebaseapp.com",
        databaseURL: "https://supertest02-689bd-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "supertest02-689bd",
        appId: "1:941347468855:web:b19101cd3237d1896bb1b2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let employeesGlobal = {};
    let currentId = "";
    const MASTER_KEY = "202429";

    // --- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô ---
    window.askAdminPassword = () => {
        if (prompt("‡∏£‡∏´‡∏±‡∏™ Master:") === MASTER_KEY) {
            document.getElementById('mainLogin').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadAdminData();
        } else { alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î!"); }
    };

    function loadAdminData() {
        onValue(ref(db, 'employees'), (snap) => {
            employeesGlobal = snap.val() || {};
            renderAdminViews();
        });
    }

    function renderAdminViews() {
        let dailyBtnHtml = '';
        let manageHtml = '';
        let monthlyHtml = '<table class="table table-sm small text-center"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏ù‡∏≤‡∏Å</th><th>‡πÄ‡∏ö‡∏¥‡∏Å</th><th>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th><th>‡∏•‡πâ‡∏≤‡∏á</th></tr></thead><tbody>';

        Object.keys(employeesGlobal).forEach(id => {
            const emp = employeesGlobal[id];
            dailyBtnHtml += `<button class="btn btn-outline-dark text-start p-3 bg-white mb-2 shadow-sm" onclick="openModal('${id}')"><b>${emp.name}</b> <span class="float-end">‚ûî</span></button>`;
            manageHtml += `<div class="card p-3 mb-2 d-flex flex-row justify-content-between align-items-center shadow-sm">
                <span><b>${emp.name}</b><br><small class="text-muted">‡πÅ‡∏£‡∏á: ${emp.dailyWage} | PIN: ${emp.pin}</small></span>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2 fw-bold" onclick="editEmployee('${id}', '${emp.name}', ${emp.dailyWage}, '${emp.pin}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteEmp('${id}')"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
            const net = (emp.balance || 0) - (emp.advance || 0);
            monthlyHtml += `<tr><td>${emp.name}</td><td>${emp.balance || 0}</td><td>${emp.advance || 0}</td><td class="fw-bold">${net}</td><td><button class="btn btn-link btn-sm" onclick="clearCycle('${id}')">‡∏•‡πâ‡∏≤‡∏á</button></td></tr>`;
        });
        document.getElementById('dailyEntryList').innerHTML = dailyBtnHtml;
        document.getElementById('adminEmpList').innerHTML = manageHtml;
        document.getElementById('monthlySummaryBody').innerHTML = monthlyHtml + '</tbody></table>';
        updateTodayReport();
    }

    async function updateTodayReport() {
        const todayStr = new Date().toLocaleDateString('th-TH');
        let html = '';
        for (let empId of Object.keys(employeesGlobal)) {
            const snap = await get(ref(db, `logs/${empId}`));
            const logs = snap.val();
            if (logs) {
                Object.keys(logs).forEach(logId => {
                    const log = logs[logId];
                    if (log.date && log.date.includes(todayStr)) {
                        const isAdv = log.type === "‡πÄ‡∏ö‡∏¥‡∏Å";
                        html += `<tr>
                            <td>${employeesGlobal[empId].name}</td>
                            <td class="${log.paidTransfer > 0 ? 'fw-bold text-primary' : ''}">${isAdv && log.paidTransfer > 0 ? '<span class="badge-advance">‡πÄ‡∏ö‡∏¥‡∏Å</span>' : ''}${log.paidTransfer || 0}</td>
                            <td class="${log.paidCash > 0 ? 'fw-bold text-warning' : ''}">${isAdv && log.paidCash > 0 ? '<span class="badge-advance">‡πÄ‡∏ö‡∏¥‡∏Å</span>' : ''}${log.paidCash || 0}</td>
                            <td class="text-success fw-bold">${log.deposit || 0}</td>
                            <td><a href="#" class="delete-btn" onclick="deleteDailyLog('${empId}', '${logId}', ${log.deposit || 0}, '${log.type}')">‡∏•‡∏ö</a></td>
                        </tr>`;
                    }
                });
            }
        }
        document.getElementById('todayReportBody').innerHTML = html || '<tr><td colspan="5" class="p-3 text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
    }

    window.openModal = (id) => {
        currentId = id;
        document.getElementById('modalEmpName').innerText = "‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤: " + employeesGlobal[id].name;
        document.getElementById('mWage').value = employeesGlobal[id].dailyWage;
        document.getElementById('mPaidTransfer').value = 0;
        document.getElementById('mPaidCash').value = 0;
        updateCalc();
        new bootstrap.Modal(document.getElementById('recordModal')).show();
    };

    const updateCalc = () => {
        const wage = parseFloat(document.getElementById('mWage').value) || 0;
        const dep = wage - (parseFloat(document.getElementById('mPaidTransfer').value) || 0) - (parseFloat(document.getElementById('mPaidCash').value) || 0);
        document.getElementById('mDeposit').innerText = dep;
    };
    ['mWage', 'mPaidTransfer', 'mPaidCash'].forEach(id => document.getElementById(id).addEventListener('input', updateCalc));

    window.saveDaily = () => {
        const wage = parseFloat(document.getElementById('mWage').value) || 0;
        const t = parseFloat(document.getElementById('mPaidTransfer').value) || 0;
        const c = parseFloat(document.getElementById('mPaidCash').value) || 0;
        const dep = wage - (t + c);
        push(ref(db, `logs/${currentId}`), { date: new Date().toLocaleString('th-TH'), wage, paidTransfer: t, paidCash: c, deposit: dep, type: "‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô" });
        update(ref(db, `employees/${currentId}`), { balance: (employeesGlobal[currentId].balance || 0) + dep });
        bootstrap.Modal.getInstance(document.getElementById('recordModal')).hide();
        updateTodayReport();
    };

    window.recordAdvance = async () => {
        const amt = parseFloat(prompt("‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤:"));
        if (!amt || isNaN(amt)) return;
        
        const typeChoice = confirm("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏ï‡∏Å‡∏•‡∏á' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î");
        const t = typeChoice ? amt : 0;
        const c = typeChoice ? 0 : amt;

        await push(ref(db, `logs/${currentId}`), { 
            date: new Date().toLocaleString('th-TH'), 
            wage: 0, paidTransfer: t, paidCash: c, deposit: -amt, type: "‡πÄ‡∏ö‡∏¥‡∏Å" 
        });
        await update(ref(db, `employees/${currentId}`), { advance: (employeesGlobal[currentId].advance || 0) + amt });
        bootstrap.Modal.getInstance(document.getElementById('recordModal')).hide();
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        updateTodayReport();
    };

    window.copyDailyReport = () => {
        let text = `üìå ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (${new Date().toLocaleDateString('th-TH')})\n\n`;
        const rows = document.querySelectorAll("#todayReportBody tr");
        if (rows.length === 0 || rows[0].innerText.includes("‡πÑ‡∏°‡πà‡∏°‡∏µ")) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); return; }
        
        rows.forEach(row => {
            const cols = row.querySelectorAll("td");
            if (cols.length < 4) return;
            const name = cols[0].innerText;
            const tVal = cols[1].innerText;
            const cVal = cols[2].innerText;
            
            let line = `- ${name}: `;
            if (tVal !== "0") line += `‡πÇ‡∏≠‡∏ô ${tVal} `;
            if (cVal !== "0") line += `‡∏™‡∏î ${cVal} `;
            text += line.trim() + "\n";
        });
        navigator.clipboard.writeText(text); alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡πà‡∏á LINE ‡πÅ‡∏•‡πâ‡∏ß");
    };

    window.copyMonthlyReport = () => {
        let txt = `üí∞ ‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (${new Date().toLocaleDateString('th-TH')})\n\n`;
        Object.keys(employeesGlobal).forEach(id => {
            const emp = employeesGlobal[id];
            txt += `- ${emp.name}: ${(emp.balance || 0) - (emp.advance || 0)} ‡∏ö‡∏≤‡∏ó\n`;
        });
        navigator.clipboard.writeText(txt); alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏•‡πâ‡∏ß");
    };

    window.deleteDailyLog = async (empId, logId, deposit, type) => {
        if (!confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ? (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô‡πÉ‡∏´‡πâ)")) return;
        await remove(ref(db, `logs/${empId}/${logId}`));
        const empSnap = await get(ref(db, `employees/${empId}`));
        const emp = empSnap.val();
        if (type === "‡πÄ‡∏ö‡∏¥‡∏Å") {
            await update(ref(db, `employees/${empId}`), { advance: (emp.advance || 0) - Math.abs(deposit) });
        } else {
            await update(ref(db, `employees/${empId}`), { balance: (emp.balance || 0) - deposit });
        }
        updateTodayReport();
    };

    window.clearCycle = (id) => { if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ?")) update(ref(db, `employees/${id}`), { balance: 0, advance: 0 }); };
    window.editEmployee = (id, n, w, p) => {
        const name = prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà:", n); if(!name) return;
        const wage = prompt("‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡πÉ‡∏´‡∏°‡πà:", w); if(!wage) return;
        const pin = prompt("PIN ‡πÉ‡∏´‡∏°‡πà:", p); if(!pin) return;
        update(ref(db, `employees/${id}`), { name, dailyWage: parseFloat(wage), pin });
    };
    window.addEmployee = () => {
        const n = document.getElementById('newName').value;
        const w = document.getElementById('newWage').value;
        const p = document.getElementById('newPin').value;
        if(n && w && p) push(ref(db, 'employees'), { name: n, dailyWage: parseFloat(w), pin: p, balance: 0, advance: 0 });
    };
    window.deleteEmp = (id) => { if(confirm("‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô?")) remove(ref(db, `employees/${id}`)); };

    // --- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: Backup & Restore ---
    window.exportBackup = async () => {
        try {
            const snap = await get(ref(db, "/"));
            const data = snap.val();
            if (!data) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");

            // ‡∏´‡∏≤‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å logs
            let allDates = [];
            if (data.logs) {
                Object.values(data.logs).forEach(userLogs => {
                    Object.values(userLogs).forEach(log => {
                        if (log.date) allDates.push(log.date.split(' ')[0]);
                    });
                });
            }
            
            let dateRangeText = "";
            if (allDates.length > 0) {
                // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yyyy ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)
                const sortedDates = allDates.sort((a,b) => {
                    const da = a.split('/').reverse().join('');
                    const db = b.split('/').reverse().join('');
                    return da > db ? 1 : -1;
                });
                dateRangeText = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${sortedDates[0]} ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${sortedDates[sortedDates.length - 1]}`;
            } else {
                dateRangeText = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date().toLocaleDateString('th-TH')}`;
            }

            const fileName = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á ${dateRangeText}.json`;
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
        } catch (e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); }
    };

    window.importBackup = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        if (!confirm("‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
            event.target.value = "";
            return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if (json.employees) {
                    await set(ref(db, "/"), json);
                    alert("‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î");
                    location.reload();
                } else {
                    alert("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
            } catch (err) { alert("‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON"); }
        };
        reader.readAsText(file);
    };

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ---
    window.showEmployeeLogin = () => {
        document.getElementById('mainLogin').style.display = 'none';
        document.getElementById('employeeSelect').style.display = 'block';
        onValue(ref(db, 'employees'), (snap) => {
            const emps = snap.val() || {};
            let h = '';
            Object.keys(emps).forEach(id => h += `<button class="btn btn-light border p-3 fw-bold mb-2 shadow-sm text-start" onclick="selectEmp('${id}', '${emps[id].name}')">${emps[id].name}</button>`);
            document.getElementById('employeeNameButtons').innerHTML = h;
        });
    };
    window.selectEmp = (id, name) => {
        currentId = id;
        document.getElementById('selectedEmpName').innerText = "‡∏Ñ‡∏∏‡∏ì " + name;
        document.getElementById('employeeSelect').style.display = 'none';
        document.getElementById('employeePinInput').style.display = 'block';
    };
    window.verifyEmpPin = async () => {
        const pin = document.getElementById('empPin').value;
        const snap = await get(ref(db, `employees/${currentId}`));
        if (snap.val() && pin === snap.val().pin.toString()) {
            document.getElementById('employeePinInput').style.display = 'none';
            document.getElementById('employeePortal').style.display = 'block';
            onValue(ref(db, `employees/${currentId}`), (s) => {
                const d = s.val();
                document.getElementById('empBalanceDisplay').innerText = (d.balance || 0).toLocaleString();
                document.getElementById('empAdvanceInfo').innerText = `‡∏¢‡∏≠‡∏î‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß: ${d.advance || 0}`;
                document.getElementById('empNetDisplay').innerText = ((d.balance || 0) - (d.advance || 0)).toLocaleString();
            });
            onValue(ref(db, `logs/${currentId}`), (s) => {
                const logs = s.val() || {};
                let h = '';
                Object.keys(logs).reverse().slice(0, 30).forEach(id => {
                    const l = logs[id];
                    const info = l.type === "‡πÄ‡∏ö‡∏¥‡∏Å" ? " <span class='text-danger'>(‡πÄ‡∏ö‡∏¥‡∏Å)</span>" : "";
                    h += `<tr><td>${l.date.split(' ')[0]}</td><td>‡πÇ‡∏≠‡∏ô ${l.paidTransfer}/‡∏™‡∏î ${l.paidCash}${info}</td><td class="text-success fw-bold">${l.deposit}</td></tr>`;
                });
                document.getElementById('empHistoryTable').innerHTML = h;
            });
        } else { alert("PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
    };

    document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>